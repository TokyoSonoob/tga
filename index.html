<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<meta name="theme-color" content="#7c3aed" />
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="icons/icon-192.png" />
<link rel="manifest" href="manifest.webmanifest">
<title>PNG → TGA (Auto) — Installable</title>
<style>
  :root{ --bg:#0b0f17; --ink:#e7eaff; --muted:#99a2d0; --acc:#7c3aed; --err:#ef4444; }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.4 system-ui,Segoe UI,Inter,Roboto,Arial; display:flex;align-items:center;justify-content:center}
  .card{width:min(560px,94vw); padding:20px; border-radius:20px; background:rgba(27,34,59,.6); border:1px solid #25335c; box-shadow:0 10px 40px rgba(124,58,237,.25)}
  h1{font-size:18px;margin:0 0 12px}
  p{margin:6px 0;color:var(--muted)}
  .big{display:block;width:100%; padding:16px 18px; border-radius:16px; border:0; background:linear-gradient(180deg,#7c3aed,#6d28d9); color:#fff; font-weight:800; font-size:16px; letter-spacing:.2px; box-shadow:0 12px 36px rgba(124,58,237,.4);}
  .big:active{transform:translateY(1px)}
  .install{margin-top:12px; display:none; width:100%; padding:12px 16px; border-radius:14px; border:1px dashed #7c3aed66; color:#c9b6ff; background:#211a39; font-weight:700}
  .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
  .tiny{flex:1; min-width:130px; padding:10px 12px; border-radius:12px; border:1px solid #33406c; background:#131a2e; color:#cbd5ff; font-weight:700}
  .tip{font-size:13px;margin-top:8px}
  .error{color:var(--err);margin-top:8px}
  footer{margin-top:14px; font-size:13px; opacity:.65}
  input[type=file]{display:none}
</style>
</head>
<body>
  <main class="card">
    <h1>PNG → TGA</h1>

    <button id="choose" class="big">เลือกไฟล์ PNG และแปลงอัตโนมัติ</button>
    <input id="file" type="file" accept="image/png" />

    <button id="installBtn" class="install">ติดตั้งเป</button>
    <p id="err" class="error"></p>
  </main>

<script>
// ---- PWA: register service worker ----
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js').catch(console.warn);
  });
}

// ---- beforeinstallprompt (show custom install button) ----
let deferredPrompt = null;
const installBtn = document.getElementById('installBtn');
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  installBtn.style.display = 'block';
});
installBtn.addEventListener('click', async () => {
  if (!deferredPrompt) return;
  deferredPrompt.prompt();
  await deferredPrompt.userChoice;
  deferredPrompt = null;
  installBtn.style.display = 'none';
});

const $file = document.getElementById('file');
const $choose = document.getElementById('choose');
const $err = document.getElementById('err');
const $clear = document.getElementById('clear');
const $sample = document.getElementById('sample');

$choose.addEventListener('click', () => $file.click());
$file.addEventListener('change', () => { if ($file.files[0]) runConvert($file.files[0]); });

$clear.addEventListener('click', () => {
  $file.value = '';
  $err.textContent = '';
});

$sample.addEventListener('click', () => {
  // create a simple 64x64 checker PNG on the fly and convert without using <input>
  const c = document.createElement('canvas');
  c.width = c.height = 64;
  const x = c.getContext('2d');
  for (let y=0;y<8;y++){
    for (let z=0;z<8;z++){
      x.fillStyle = (y+z)%2 ? '#7c3aed' : '#111827';
      x.fillRect(z*8,y*8,8,8);
    }
  }
  c.toBlob((blob)=>{
    if (!blob) return;
    const f = new File([blob], 'sample.png', {type:'image/png'});
    runConvert(f);
  }, 'image/png');
});

function encodeTGA(imgData, width, height){
  // Always export 32-bit BGRA, top-left origin
  const bytesPerPixel = 4;
  const header = new Uint8Array(18);
  header[2] = 2; // uncompressed true-color
  header[12] = width & 0xFF;
  header[13] = (width>>8) & 0xFF;
  header[14] = height & 0xFF;
  header[15] = (height>>8) & 0xFF;
  header[16] = 32; // pixel depth
  header[17] = 0x20 | 8; // top-left origin + 8 attr bits (alpha)

  const out = new Uint8Array(18 + width*height*bytesPerPixel);
  out.set(header, 0);
  const dst = out.subarray(18);
  const src = imgData.data; // RGBA

  for(let y=0; y<height; y++){
    for(let x=0; x<width; x++){
      const si = (y*width + x) * 4;
      const di = (y*width + x) * bytesPerPixel;
      dst[di]   = src[si+2]; // B
      dst[di+1] = src[si+1]; // G
      dst[di+2] = src[si];   // R
      dst[di+3] = src[si+3]; // A
    }
  }
  return new Blob([out], { type: 'image/x-tga' });
}

async function runConvert(file){
  try{
    $err.textContent = '';
    if(!/\.png$/i.test(file.name) && !/image\/png/i.test(file.type)){
      throw new Error('โปรดเลือกไฟล์ PNG เท่านั้น');
    }
    const url = URL.createObjectURL(file);
    const img = new Image();
    img.decoding = 'async';
    img.onload = () => {
      const w = img.naturalWidth, h = img.naturalHeight;
      const c = document.createElement('canvas');
      c.width = w; c.height = h;
      const ctx = c.getContext('2d', { willReadFrequently: true });
      ctx.drawImage(img, 0, 0);
      const data = ctx.getImageData(0,0,w,h);
      const tga = encodeTGA(data, w, h);
      const name = file.name.replace(/\.[^.]+$/, '') + '.tga';
      const a = document.createElement('a');
      a.href = URL.createObjectURL(tga);
      a.download = name;
      document.body.appendChild(a);
      a.click();
      URL.revokeObjectURL(a.href);
      a.remove();
      URL.revokeObjectURL(url);
      // reset input for mobile so same file can be selected again
      $file.value = '';
    };
    img.onerror = () => { throw new Error('ไม่สามารถเปิดภาพได้'); };
    img.src = url;
  }catch(e){
    console.error(e);
    $err.textContent = e?.message || String(e);
  }
}
</script>
</body>
</html>
