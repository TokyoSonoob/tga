<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<meta name="theme-color" content="#7c3aed" />
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="icons/icon-192.png" />
<link rel="manifest" href="manifest.webmanifest">
<title>PNG ‚Üí TGA (Auto) ‚Äî Installable</title>
<style>
  :root{ --bg:#0b0f17; --ink:#e7eaff; --muted:#99a2d0; --acc:#7c3aed; --err:#ef4444; }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.4 system-ui,Segoe UI,Inter,Roboto,Arial; display:flex;align-items:center;justify-content:center}
  .card{width:min(560px,94vw); padding:20px; border-radius:20px; background:rgba(27,34,59,.6); border:1px solid #25335c; box-shadow:0 10px 40px rgba(124,58,237,.25)}
  h1{font-size:18px;margin:0 0 12px}
  p{margin:6px 0;color:var(--muted)}
  .big{display:block;width:100%; padding:16px 18px; border-radius:16px; border:0; background:linear-gradient(180deg,#7c3aed,#6d28d9); color:#fff; font-weight:800; font-size:16px; letter-spacing:.2px; box-shadow:0 12px 36px rgba(124,58,237,.4);}
  .big:active{transform:translateY(1px)}
  .install{margin-top:12px; display:none; width:100%; padding:12px 16px; border-radius:14px; border:1px dashed #7c3aed66; color:#c9b6ff; background:#211a39; font-weight:700}
  .error{color:var(--err);margin-top:8px}
  footer{margin-top:14px; font-size:13px; opacity:.65}
  input[type=file]{display:none}
</style>
</head>
<body>
  <main class="card">
    <h1>PNG ‚Üí TGA</h1>

    <button id="choose" class="big">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå PNG ‡πÅ‡∏•‡∏∞‡πÅ‡∏õ‡∏•‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</button>
    <input id="file" type="file" accept="image/png" />

    <button id="installBtn" class="install">‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏≠‡∏õ‡πÉ‡∏ô Chrome</button>
    <p id="err" class="error"></p>
    <footer>‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏Æ‡∏™‡∏ï‡πå‡∏ú‡πà‡∏≤‡∏ô HTTPS + Service Worker ‚Ä¢ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏´‡∏•‡∏±‡∏Å‡πÑ‡∏î‡πâ (PWA)</footer>
  </main>

<script>
// ---- PWA: register service worker (‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå sw.js ‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà‡∏£‡∏≤‡∏Å‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô) ----
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js').catch(console.warn);
  });
}

// ---- beforeinstallprompt (‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏û‡∏£‡πâ‡∏≠‡∏°) ----
let deferredPrompt = null;
const installBtn = document.getElementById('installBtn');
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  installBtn.style.display = 'block';
});
installBtn.addEventListener('click', async () => {
  if (!deferredPrompt) return;
  deferredPrompt.prompt();
  await deferredPrompt.userChoice;
  deferredPrompt = null;
  installBtn.style.display = 'none';
});

// ---- PNG ‚Üí TGA (32-bit, Top-Left origin) ----
const $file = document.getElementById('file');
const $choose = document.getElementById('choose');
const $err = document.getElementById('err');

$choose.addEventListener('click', () => $file.click());
$file.addEventListener('change', () => { if ($file.files[0]) runConvert($file.files[0]); });

function encodeTGA(imgData, width, height){
  const header = new Uint8Array(18);
  header[2] = 2; // true-color
  header[12] = width & 0xFF;  header[13] = (width>>8) & 0xFF;
  header[14] = height & 0xFF; header[15] = (height>>8) & 0xFF;
  header[16] = 32; // 32-bit
  header[17] = 0x20 | 8; // Top-Left + alpha bits

  const out = new Uint8Array(18 + width*height*4);
  out.set(header, 0);
  const dst = out.subarray(18);
  const src = imgData.data; // RGBA

  for(let y=0; y<height; y++){
    for(let x=0; x<width; x++){
      const si = (y*width + x) * 4;
      const di = (y*width + x) * 4;
      dst[di]   = src[si+2]; // B
      dst[di+1] = src[si+1]; // G
      dst[di+2] = src[si];   // R
      dst[di+3] = src[si+3]; // A
    }
  }
  return new Blob([out], { type: 'image/x-tga' });
}

async function runConvert(file){
  try{
    $err.textContent = '';
    if(!/\.png$/i.test(file.name) && !/image\/png/i.test(file.type)){
      throw new Error('‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå PNG ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô');
    }
    const url = URL.createObjectURL(file);
    const img = new Image();
    img.decoding = 'async';
    img.onload = () => {
      const w = img.naturalWidth, h = img.naturalHeight;
      const c = document.createElement('canvas');
      c.width = w; c.height = h;
      const ctx = c.getContext('2d', { willReadFrequently: true });
      ctx.drawImage(img, 0, 0);
      const data = ctx.getImageData(0,0,w,h);
      const tga = encodeTGA(data, w, h);
      const name = file.name.replace(/\.[^.]+$/, '') + '.tga';
      const a = document.createElement('a');
      a.href = URL.createObjectURL(tga);
      a.download = name;
      document.body.appendChild(a);
      a.click();
      URL.revokeObjectURL(a.href);
      a.remove();
      URL.revokeObjectURL(url);
      $file.value = '';
    };
    img.onerror = () => { throw new Error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏¥‡∏î‡∏†‡∏≤‡∏û‡πÑ‡∏î‡πâ'); };
    img.src = url;
  }catch(e){
    console.error(e);
    $err.textContent = e?.message || String(e);
  }
}
</script>

<!-- üß© ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå 2 ‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏µ‡πâ‡∏Ç‡πâ‡∏≤‡∏á‡πÜ index.html ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Add to Home Screen:
1) manifest.webmanifest
{
  "name": "PNG ‚Üí TGA (Auto)",
  "short_name": "PNG‚ÜíTGA",
  "start_url": "./",
  "display": "standalone",
  "background_color": "#0b0f17",
  "theme_color": "#7c3aed",
  "icons": [
    { "src": "icons/icon-192.png", "sizes": "192x192", "type": "image/png", "purpose": "any maskable" },
    { "src": "icons/icon-512.png", "sizes": "512x512", "type": "image/png", "purpose": "any maskable" }
  ]
}

2) sw.js (service worker)
const CACHE = 'png2tga-v1';
const ASSETS = [ './', './index.html', './manifest.webmanifest', './icons/icon-192.png', './icons/icon-512.png' ];
self.addEventListener('install', e=>{ e.waitUntil(caches.open(CACHE).then(c=>c.addAll(ASSETS))); });
self.addEventListener('activate', e=>{ e.waitUntil((async()=>{ const keys=await caches.keys(); await Promise.all(keys.filter(k=>k!==CACHE).map(k=>caches.delete(k))); self.clients.claim(); })()); });
self.addEventListener('fetch', e=>{ const u=new URL(e.request.url); if(u.origin===location.origin){ e.respondWith((async()=>{ const c=await caches.match(e.request); if(c) return c; const r=await fetch(e.request); if(e.request.method==='GET' && r.status===200){ (await caches.open(CACHE)).put(e.request, r.clone()); } return r; })()); }});

‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô: ‡∏ß‡∏≤‡∏á‡∏ó‡∏µ‡πà icons/icon-192.png ‡πÅ‡∏•‡∏∞ icons/icon-512.png -->
</body>
</html>
